<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <!-- This is broken by doc revisioning.
        <link rel="canonical" href="http://mynewt.apache.org/network/ble/ble_setup/ble_lp_clock/"> -->
        <link rel="shortcut icon" href="../../../../img/favicon.ico">

	    <title>Configure clock for controller - Apache Mynewt</title>

        <link href="../../../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../../css/highlight.css">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link href="../../../../css/custom.css" rel="stylesheet">
        <link href="../../../../css/v2.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="../../../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-72162311-1', 'auto');
                ga('send', 'pageview');
            </script>
        
    </head>


    <body class="Configure clock for controller">


        <div class="container">
    <div class="row v2-main-banner">
        <a class="logo-cell" href="/">
            <img class="logo" src="/img/logo.png">
        </a>
        <div class="tagline-cell">
            <h4 class="tagline">An OS to build, deploy and securely manage billions of devices</h4>
        </div>
        <div class="news-cell">
            <div class="well">
                <h4>Latest News:</h4> <a href="/download">Apache Mynewt 1.2.0</a> released (September 12, 2017)
            </div>
        </div>
    </div>
</div>

        






<nav id="navbar" class="navbar navbar-inverse affix-top" data-spy="affix" data-offset-top="150" role="navigation">
    <div class="container">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li 
  class=""
>
                    <a href="/"><i class="fa fa-home" style="font-size: larger;"></i></a>
                </li>
                <li 
  class="important"
>
                    <a href="/quick-start/">Quick Start</a>
                </li>
                <li 
  class=""
>
                    <a href="/about/">About</a>
                </li>
                <li 
  class=""
>
                    <a href="/talks/">Talks</a>
                </li>
                <li 
  class="active"
>
                    <a href="/latest/os/introduction">Documentation</a>
                </li>
                <li 
  class=""
>
                    <a href="/download/">Download</a>
                </li>
                <li 
  class=""
>
                    <a href="/community/">Community</a>
                </li>
                <li 
  class=""
>
                    <a href="/events/">Events</a>
                </li>
            </ul>

        </div>
    </div>
</nav>

        

        <div class="container">
            
                <div class="row">
                    <div class="col-md-3 v2-sidebar sidebar-container"><div id="docSidebar" class="hidden-print" role="complementary">
    <div class="top">
        <div role="search">
            <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" class="form-control" placeholder="Search documentation" />
                </div>
            </form>
        </div>
    </div>
    <ul class="toc-nav">
      <li class="doc-version">
<select class="form-control" onchange="if (this.value) window.location.href=this.value">
    <option
      value="/latest/os/introduction"
      selected="selected"
      >
      Version: master (latest)
    </option>
    <option
      value="/v1_1_0/os/introduction"
      
      >
      Version: 1.1.0
    </option>
    <option
      value="/v1_0_0/os/introduction"
      
      >
      Version: 1.0.0
    </option>
    <option
      value="/v0_9_0/os/introduction"
      
      >
      Version: 0_9_0
    </option>
</select></li>
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
  
  
    <li ><a href="../../../../os/introduction/">Mynewt Documentation</a>
  
  
    <ul>
          
              
          
              
                
  
  
    <li ><a href="../../../../os/get_started/get_started/">Basic Setup</a>
  
  
    </li>

              
          
              
                
    <li >
      <a href="../../../../os/get_started/vocabulary/">Concepts</a>
    </li>

              
          
              
                
  
  
    <li ><a href="../../../../os/tutorials/tutorials/">Tutorials</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../../../os/os_user_guide/">OS User Guide</a>
  
  
    </li>

              
          
              
                
  
  
    <li><a href="
  ../../ble_intro/
">BLE User Guide</a>
  
  
    <ul>
          
              
                
    <li >
      <a href="../../ble_intro/">NimBLE Introduction</a>
    </li>

              
          
              
                
    <li >
      <a href="../../ble_sec/">NimBLE Security</a>
    </li>

              
          
              
                
  
  
    <li ><a href="../ble_setup_intro/">NimBLE Setup</a>
  
  
    <ul>
          
              
          
              
                
    <li class="active">
      <a href="./">Configure clock for controller</a>
    </li>

              
          
              
                
    <li >
      <a href="../ble_addr/">Configure device address</a>
    </li>

              
          
              
                
    <li >
      <a href="../ble_sync_cb/">Configure sync callbacks</a>
    </li>

              
          
    </ul>
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../ble_hs/ble_hs/">NimBLE Host API</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../bletiny/bletiny_api/">bletiny app Usage API</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../btshell/btshell_api/">btshell app Usage API</a>
  
  
    </li>

              
          
    </ul>
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../../../newt/newt_intro/">Newt Tool Guide</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../../../newtmgr/overview/">Newt Manager Guide</a>
  
  
    </li>

              
          
              
                
    <li >
      <a href="../../../../known_issues/">Known Issues</a>
    </li>

              
          
    </ul>
  
    </li>

        
      
        
          
  
  
    <li><a href="
  ../../../../newt/install/prev_releases/
">Appendix</a>
  
  
    </li>

        
      
    </ul>
</div></div>

                    <div class="col-md-9" role="main">
                        <div class="doc-header">
                            <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="/latest/os/introduction">Docs</a></li>
    
    
        
          <li>&raquo; <a href="../../ble_intro/">BLE User Guide</a></li>
        
      
        
          <li>&raquo; <a href="../ble_setup_intro/">NimBLE Setup</a></li>
        
      
      
        <li>&raquo; Configure clock for controller</li>
      
    
    
      <li class="wy-breadcrumbs-aside">
        
          <a href="https://github.com/apache/mynewt-site/blob/master/docs/network/ble/ble_setup/ble_lp_clock.md"
            class="icon icon-github"> Edit on GitHub</a>
        
      </li>
    
  </ul>
</div>
                        </div>
                        
                        
                            <h2 id="configure-clock-for-controller">Configure clock for controller</h2>
<p>The NimBLE stack uses OS cputime for scheduling various events inside controller.
Since the code of controller is optimized to work with 32768 Hz clock, the OS
cputime has to be configured accordingly.</p>
<p>To make things easier, controller package (<code>net/nimble/controller</code>) defines new
system configuration setting <code>BLE_LP_CLOCK</code> as sets it to <code>1</code> so other packages
can be configured if necessary. The next section describes configuration required
for controller to work properly.</p>
<h3 id="system-configuration">System configuration</h3>
<p><strong>Note:</strong> All BSPs based on nRF5x have below settings automatically applied when
<code>BLE_LP_CLOCK</code> is set, there is no need to configure this in application.</p>
<p>The following things need to be configured for NimBLE controller to work properly:</p>
<ul>
<li>OS cputime frequency shall be set to <code>32768</code></li>
<li>OS cputime timer source shall be set to 32768 Hz clock source</li>
<li>Default 1 MHz clock source can be disabled if not used by application</li>
<li>32768 Hz clock source shall be enabled</li>
<li>Crystal settling time shall be set to non-zero value (see <a href="#crystal-settle-time-configuration">below</a>)</li>
</ul>
<p>For example, on nRF52 platform timer 5 can be used as source for 32768 Hz clock.
Also, timer 0 can be disabled since this is the default source for OS cputime
clock and is no longer used. The configuration will look as below:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span></span>syscfg.vals:
    OS_CPUTIME_FREQ: 32768
    OS_CPUTIME_TIMER_NUM: 5
    TIMER_0: 0
    TIMER_5: 1
    BLE_XTAL_SETTLE_TIME: 1500
</pre></div>


<p>On nRF51 platform the only difference is to use timer 3 instead of timer 5.</p>
<p>On platforms without 32768 Hz crystal available it usually can be synthesized by
setting <code>XTAL_32768_SYNTH</code> to <code>1</code> - this is also already configured in existing
BSPs.</p>
<h3 id="crystal-settle-time-configuration">Crystal settle time configuration</h3>
<p>The configuration variable <code>BLE_XTAL_SETTLE_TIME</code> is used by the controller to turn
on the necessary clock source(s) for the radio and associated peripherals prior to
Bluetooth events (advertising, scanning, connections, etc). For the nRF5x platforms,
the HFXO needs to be turned on prior to using the radio and the <code>BLE_XTAL_SETTLE_TIME</code>
must be set to accommodate this time. The amount of time required is board dependent,
so users must characterize their hardware and set <code>BLE_XTAL_SETTLE_TIME</code> accordingly.
The current value of 1500 microseconds is a fairly long time and was intended to work
for most, if not all, platforms.</p>
<p>Note that changing this time will impact battery life with the amount depending on the
application. The HFXO draws a fairly large amount of current when running so keeping
this time as small as possible will reduce overall current drain.</p>
                        
                        <div class="row">
                            



<ul class="nav nav-pills" style="margin-bottom: 10px">
    <li>
    
    <a href=../ble_setup_intro/>
        <span class="fa fa-arrow-left"></span>
        Previous: NimBLE Setup
    </a>
    
    </li>
    <li class="pull-right">
    
    <a href=../ble_addr/>
        Next: Configure device address
        <span class="fa fa-arrow-right"></span>
    </a>
    
    </li>
</ul>
                        </div>
                        <footer class="row">
    <div class="col-xs-12">
        
            <p class="copyright">Apache Mynewt is available under Apache License, version 2.0.</p>
        
    </div>
    <div class="col-xs-12">
        <div class="logos">
            <img src="/img/asf_logo_wide_small.png" alt="Apache" title="Apache">
            <small class="footnote">
            Apache Mynewt, Mynewt, Apache, the Apache feather logo, and the Apache Mynewt project logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and other countries.
            </small>
             <a href="https://join.slack.com/mynewt/shared_invite/MTkwMTg1ODM1NTg5LTE0OTYxNzQ4NzQtZTU1YmNhYjhkMg"><img src="https://www.countit.com/images/add_to_slack.png" alt="Slack Icon" title="Join our Slack Community" /></a>
        </div>
    </div>
</footer>
                    </div>
                </div>
            
            
        </div>

        <script src="../../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../../js/highlight.pack.js"></script>
        <script src="../../../../js/base.js"></script>
        <script src="../../../../js/custom.js"></script>

    </body>
</html>
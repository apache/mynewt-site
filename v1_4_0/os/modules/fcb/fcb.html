

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    <title>Flash Circular Buffer (FCB) &mdash; Apache Mynewt latest documentation</title>
    

    
    
      <link rel="shortcut icon" href="../../../_static/mynewt-logo-only-newt32x32.png"/>
    

    

    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

    
      <link rel="stylesheet" href="../../../_static/css/sphinx_theme.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/bootstrap-3.0.3.min.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/v2.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    
      <link rel="stylesheet" href="../../../_static/css/restructuredtext.css" type="text/css" />
    

    

    <link rel="stylesheet" href="../../../_static/css/overrides.css" type="text/css" />
          <link rel="index" title="Index"
                href="../../../genindex.html"/>
          <link rel="search" title="Search" href="../../../search.html"/>
      <link rel="top" title="Apache Mynewt latest documentation" href="../../../index.html"/> 

    
    <script src="../../../_static/js/modernizr.min.js"></script>

    

  </head>

  <body class="not-front page-documentation" role="document" >
    <div id="wrapper">
      <div class="container">
    <div id="banner" class="row v2-main-banner">
        <a class="logo-cell" href="/">
            <img class="logo" src="../../../_static/img/logo.png">
        </a>
        <div class="tagline-cell">
            <h4 class="tagline">An OS to build, deploy and securely manage billions of devices</h4>
        </div>
        <div class="news-cell">
            <div class="well">
                <h4>Latest News:</h4> <a href="/download">Apache Mynewt 1.12.0, Apache NimBLE 1.7.0 </a> released April 4, 2024)
            </div>
        </div>
    </div>
</div>
      
<header>
    <nav id="navbar" class="navbar navbar-inverse" role="navigation">
        <div class="container">
            <!-- Collapsed navigation -->
            <div class="navbar-header">
                <!-- Expander button -->
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>

            <!-- Expanded navigation -->
            <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/"><i class="fa fa-home" style="font-size: larger;"></i></a>
                    </li>
                    <li class="important">
                        <a href="/quick-start/">Quick Start</a>
                    </li>
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    <li>
                        <a href="/talks/">Talks</a>
                    </li>
                    <li class="active">
                        <a href="/documentation/">Documentation</a>
                    </li>
                    <li>
                        <a href="/download/">Download</a>
                    </li>
                    <li>
                        <a href="/community/">Community</a>
                    </li>
                    <li>
                        <a href="/cve/">CVE</a>
                    </li>
                </ul>

                <!-- Search, Navigation and Repo links -->
                <ul class="nav navbar-nav navbar-right">
                    
                </ul>
            </div>
        </div>
    </nav>
</header>
      <!-- STARTS MAIN CONTENT -->
      <div id="main-content">
        





<div id="breadcrumb">
  <div class="container">
    <a href="/documentation/">Docs</a> /
    
    Flash Circular Buffer (FCB)
    
  <div class="sourcelink">
    <a href="https://github.com/apache/mynewt-core/edit/master/docs/os/modules/fcb/fcb.rst" class="icon icon-github"
           rel="nofollow"> Edit on GitHub</a>
</div>
  </div>
</div>
        <!-- STARTS CONTAINER -->
        <div class="container">
          <!-- STARTS .content -->
          <div id="content" class="row">
            
            <!-- STARTS .container-sidebar -->
<div class="container-sidebar col-xs-12 col-sm-3">
  <div id="docSidebar" class="sticky-container">
    <div role="search" class="sphinx-search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search documentation" class="search-documentation" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
    <!-- Note: only works when deployed -->
<select class="form-control" onchange="if (this.value) window.location.href=this.value">
  <option value="/latest" selected>
    Version: latest
  </option>
  <option value="/v1_12_0" >
    Version: 1.12.0
  </option>
  <option value="/v1_11_0" >
    Version: 1.11.0
  </option>
  <option value="/v1_10_0" >
    Version: 1.10.0
  </option>
  <option value="/v1_9_0" >
    Version: 1.9.0
  </option>
  <option value="/v1_8_0" >
    Version: 1.8.0
  </option>
  <option value="/v1_7_0" >
    Version: 1.7.0
  </option>
  <option value="/v1_6_0" >
    Version: 1.6.0
  </option>
  <option value="/v1_5_0" >
    Version: 1.5.0
  </option>
  <option value="/v1_4_0" selected="selected" >
    Version: 1.4.0
  </option>
  <option value="/v1_3_0/os/introduction" >
    Version: 1.3.0
  </option>
  <option value="/v1_2_0/os/introduction" >
    Version: 1.2.0
  </option>
  <option value="/v1_1_0/os/introduction" >
    Version: 1.1.0
  </option>
  <option value="/v1_0_0/os/introduction" >
    Version: 1.0.0
  </option>
  <option value="/v0_9_0/os/introduction" >
    Version: 0.9.0
  </option>
</select>
    <div class="region region-sidebar">
      <div class="docs-menu">
      
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/index.html">Setup &amp; Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../external_links.html">Third-party Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../os_user_guide.html">OS User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/index.html">BLE User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../newt/index.html">Newt Tool Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../newtmgr/index.html">Newt Manager Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mynewt_faq/index.html">Mynewt FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/index.html">Appendix</a></li>
</ul>

        
      
      </div>
    </div>
  </div>
  <!-- ENDS STICKY CONTAINER -->
</div>
<!-- ENDS .container-sidebar -->

            <div class="col-xs-12 col-sm-9">
              
                <div class="alert alert-warning">
                  <p>
                    Version 1.4.0 is not the most recent version of the
                    Apache Mynewt documentation. Click <a href="/latest">here</a> to
                    read the latest version.
                  </p>
                </div>
              

              
              <div class="">
                <div class="rst-content">
                  <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                   <div itemprop="articleBody">
                    
  <div class="section" id="flash-circular-buffer-fcb">
<h1>Flash Circular Buffer (FCB)<a class="headerlink" href="#flash-circular-buffer-fcb" title="Permalink to this headline">¶</a></h1>
<p>Flash circular buffer provides an abstration through which you can treat
flash like a FIFO. You append entries to the end, and read data from the
beginning.</p>
<div class="section" id="description">
<h2>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>Elements in the flash contain the length of the element, the data within
the element, and checksum over the element contents.</p>
<p>Storage of elements in flash is done in a FIFO fashion. When user
requests space for the next element, space is located at the end of the
used area. When user starts reading, the first element served is the
oldest element in flash.</p>
<p>Elements can be appended to the end of the area until storage space is
exhausted. User has control over what happens next; either erase oldest
block of data, thereby freeing up some space, or stop writing new data
until existing data has been collected. FCB treats underlying storage as
an array of flash sectors; when it erases old data, it does this a
sector at a time.</p>
<p>Elements in the flash are checksummed. That is how FCB detects whether
writing element to flash completed ok. It will skip over entries which
don’t have a valid checksum.</p>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>To add an element to circular buffer:</p>
<ul class="simple">
<li><p>Call fcb_append() to get the location where data can be written. If
this fails due to lack of space, you can call fcb_rotate() to make
some. And then call fcb_append() again.</p></li>
<li><p>Use flash_area_write() to write element contents.</p></li>
<li><p>Call fcb_append_finish() when done. This completes the entry by
calculating the checksum.</p></li>
</ul>
<p>To read contents of the circular buffer: * Call fcb_walk() with a
pointer to your callback function. * Within callback function copy in
data from the element using flash_area_read(). You can tell when all
data from within a sector has been read by monitoring returned element’s
area pointer. Then you can call fcb_rotate(), if you’re done with that
data.</p>
<p>Alternatively: * Call fcb_getnext() with 0 in element offset to get
the pointer to oldest element. * Use flash_area_read() to read
element contents. * Call fcb_getnext() with pointer to current element
to get the next one. And so on.</p>
</div>
<div class="section" id="data-structures">
<h2>Data structures<a class="headerlink" href="#data-structures" title="Permalink to this headline">¶</a></h2>
<p>This data structure describes the element location in the flash. You
would use it figure out what parameters to pass to flash_area_read()
to read element contents. Or to flash_area_write() when adding a new
element.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fcb_entry</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">flash_area</span> <span class="o">*</span><span class="n">fe_area</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">fe_elem_off</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">fe_data_off</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">fe_data_len</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 43%" />
<col style="width: 57%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Element</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>fe_area</p></td>
<td><p>Pointer to
info about the
flash sector.
Pass this to
flash_area_x
x()
routines.</p></td>
</tr>
<tr class="row-odd"><td><p>fe_elem_
off</p></td>
<td><p>Byte offset
from the start
of the sector
to beginning
of element.</p></td>
</tr>
<tr class="row-even"><td><p>fe_data_
off</p></td>
<td><p>Byte offset
from start of
the sector to
beginning of
element data.
Pass this to
to
flash_area_x
x()
routines.</p></td>
</tr>
<tr class="row-odd"><td><p>fe_data_
len</p></td>
<td><p>Number of
bytes in the
element.</p></td>
</tr>
</tbody>
</table>
<p>The following data structure describes the FCB itself. First part should
be filled in by the user before calling fcb_init(). The second part is
used by FCB for its internal bookkeeping.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fcb</span> <span class="p">{</span>
    <span class="cm">/* Caller of fcb_init fills this in */</span>
    <span class="kt">uint32_t</span> <span class="n">f_magic</span><span class="p">;</span>           <span class="cm">/* As placed on the disk */</span>
    <span class="kt">uint8_t</span> <span class="n">f_version</span><span class="p">;</span>          <span class="cm">/* Current version number of the data */</span>
    <span class="kt">uint8_t</span> <span class="n">f_sector_cnt</span><span class="p">;</span>       <span class="cm">/* Number of elements in sector array */</span>
    <span class="kt">uint8_t</span> <span class="n">f_scratch_cnt</span><span class="p">;</span>      <span class="cm">/* How many sectors should be kept empty */</span>
    <span class="k">struct</span> <span class="n">flash_area</span> <span class="o">*</span><span class="n">f_sectors</span><span class="p">;</span> <span class="cm">/* Array of sectors, must be contiguous */</span>

    <span class="cm">/* Flash circular buffer internal state */</span>
    <span class="k">struct</span> <span class="n">os_mutex</span> <span class="n">f_mtx</span><span class="p">;</span>      <span class="cm">/* Locking for accessing the FCB data */</span>
    <span class="k">struct</span> <span class="n">flash_area</span> <span class="o">*</span><span class="n">f_oldest</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">fcb_entry</span> <span class="n">f_active</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">f_active_id</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">f_align</span><span class="p">;</span>            <span class="cm">/* writes to flash have to aligned to this */</span>
<span class="p">};</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 43%" />
<col style="width: 57%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Element</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>f_magic</p></td>
<td><p>Magic number
in the
beginning of
FCB flash
sector. FCB
uses this when
determining
whether sector
contains valid
data or not.</p></td>
</tr>
<tr class="row-odd"><td><p>f_version</p></td>
<td><p>Current
version number
of the data.
Also stored in
flash sector
header.</p></td>
</tr>
<tr class="row-even"><td><p>f_sector_cnt</p></td>
<td><p>Number of
elements in
the f_sectors
array.</p></td>
</tr>
<tr class="row-odd"><td><p>f_scratch
_cnt</p></td>
<td><p>Number of
sectors to
keep empty.
This can be
used if you
need to have
scratch space
for garbage
collecting
when FCB fills
up.</p></td>
</tr>
<tr class="row-even"><td><p>f_sectors</p></td>
<td><p>Array of
entries
describing
flash sectors
to use.</p></td>
</tr>
<tr class="row-odd"><td><p>f_mtx</p></td>
<td><p>Lock
protecting
access to FCBs
internal data.</p></td>
</tr>
<tr class="row-even"><td><p>f_oldest</p></td>
<td><p>Pointer to
flash sector
containing the
oldest data.
This is where
data is served
when read is
started.</p></td>
</tr>
<tr class="row-odd"><td><p>f_active</p></td>
<td><p>Flash location
where the
newest data
is. This is
used by
fcb_append()
to figure out
where the data
should go to.</p></td>
</tr>
<tr class="row-even"><td><p>f_active_id</p></td>
<td><p>Flash sectors
are assigned
ever-increasin
g
serial
numbers. This
is how FCB
figures out
where oldest
data is on
system
restart.</p></td>
</tr>
<tr class="row-odd"><td><p>f_align</p></td>
<td><p>Some flashes
have
restrictions
on alignment
for writes.
FCB keeps a
copy of this
number for the
flash here.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="list-of-functions">
<h2>List of Functions<a class="headerlink" href="#list-of-functions" title="Permalink to this headline">¶</a></h2>
<p>The functions available in this OS feature are:</p>
</div>
</div>


                   </div>
                  </div>
                  
                </div>
              </div>
            </div>
            <!-- ENDS CONTENT SECTION -->
          </div>
          <!-- ENDS .content -->
        </div>
      </div>
      <footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-12">
          
              <p class="copyright">Apache Mynewt is available under Apache License, version 2.0.</p>
          
      </div>
      <div class="col-xs-12">
          <div class="logos">
              <img src="../../../_static/img/asf_logo_wide_small.png" alt="Apache" title="Apache">
              <small class="footnote">
                Apache Mynewt, Mynewt, Apache, the Apache feather logo, and the Apache Mynewt project logo are either
                registered trademarks or trademarks of the Apache Software Foundation in the United States and other countries.
              </small>
              <a href="">
                <img src="../../../_static/img/add_to_slack.png" alt="Slack Icon" title="Join our Slack Community" />
              </a>
          </div>
      </div>
    </div>
  </div>
</footer>
    </div>
    <!-- ENDS #wrapper -->

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'latest',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt',
            LINK_SUFFIX: '.html'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/js/bootstrap-3.0.3.min.js"></script>
      <script type="text/javascript" src="../../../_static/js/affix.js"></script>
      <script type="text/javascript" src="../../../_static/js/main.js"></script>

   

  </body>
</html>
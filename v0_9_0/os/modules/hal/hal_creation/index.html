<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <!-- This is broken by doc revisioning.
         -->
        <link rel="shortcut icon" href="../../../../img/favicon.ico">

        <title>Creating HAL - Apache Mynewt</title>

        <link href="../../../../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../../css/highlight.css">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link href="../../../../css/custom.css" rel="stylesheet">
        <link href="../../../../css/v2.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
            <script>
            (function(i, s, o, g, r, a, m) {
    i["GoogleAnalyticsObject"] = r;
    (i[r] =
        i[r] ||
        function() {
            (i[r].q = i[r].q || []).push(arguments);
        }),
        (i[r].l = 1 * new Date());
    (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m);
})(window, document, "script", "//www.google-analytics.com/analytics.js", "ga");

ga("create", "UA-72162311-1", "auto");
ga("send", "pageview");
</script>
        
    </head>


    <body class="Creating HAL">


        <div class="container">
    <div class="row v2-main-banner">
        <a class="logo-cell" href="/">
            <img class="logo" src="/img/logo.png">
        </a>
        <div class="tagline-cell">
            <h4 class="tagline">An OS to build, deploy and securely manage billions of devices</h4>
        </div>
        <div class="news-cell">
            <div class="well">
                <h4>Latest News:</h4> <a href="/download">Apache Mynewt 1.12.0, Apache NimBLE 1.7.0 </a> released (April 4, 2024)
            </div>
        </div>
    </div>
</div>

        






<nav id="navbar" class="navbar navbar-inverse affix-top" data-spy="affix" data-offset-top="150" role="navigation">
    <div class="container">
        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav navbar-right">
                <li 
  class=""
>
                    <a href="/"><i class="fa fa-home" style="font-size: larger;"></i></a>
                </li>
                <li 
  class="important"
>
                    <a href="/quick-start/">Quick Start</a>
                </li>
                <li 
  class=""
>
                    <a href="/about/">About</a>
                </li>
                <li 
  class=""
>
                    <a href="/talks/">Talks</a>
                </li>
                <li 
  class="active  "
>
                    <a href="/documentation/">Documentation</a>
                </li>
                <li 
  class=""
>
                    <a href="/download/">Download</a>
                </li>
                <li 
  class=""
>
                    <a href="/community/">Community</a>
                </li>
                <li 
  class=""
>
                    <a href="/cve/">CVE</a>
                </li>
            </ul>

        </div>
    </div>
</nav>

        

        <div class="container">
            
                <div class="row">
                    <div class="col-md-3 v2-sidebar sidebar-container"><div id="docSidebar" class="hidden-print" role="complementary">
    <div class="top">
        <div role="search">
            <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
                <div class="form-group">
                    <input type="text" name="q" class="form-control" placeholder="Search documentation" />
                </div>
            </form>
        </div>
    </div>
    <ul class="toc-nav">
      <li class="doc-version"><select class="form-control" onchange="if (this.value) window.location.href=this.value">
  <option value="/latest">
    Version: latest
  </option>

  <option value="/master/" >
    Version: master
  </option>
    <option value="/v1_12_0/" >
    Version: 1.12.0
  </option>
  <option value="/v1_11_0/" >
    Version: 1.11.0
  </option>
  <option value="/v1_10_0/" >
    Version: 1.10.0
  </option>
  <option value="/v1_9_0/" >
    Version: 1.9.0
  </option>
    <option value="/v1_8_0/" >
    Version: 1.8.0
  </option>
  <option value="/v1_7_0/" >
    Version: 1.7.0
  </option>
  <option value="/v1_6_0/" >
    Version: 1.6.0
  </option>
  <option value="/v1_5_0/" >
    Version: 1.5.0
  </option>
  <option value="/v1_4_0/" >
    Version: 1.4.0
  </option>
  <option value="/v1_3_0/os/introduction" >
    Version: 1.3.0
  </option>
  <option value="/v1_2_0/os/introduction" >
    Version: 1.2.0
  </option>
  <option value="/v1_1_0/os/introduction" >
    Version: 1.1.0
  </option>
  <option value="/v1_0_0/os/introduction" >
    Version: 1.0.0
  </option>
  <option value="/v0_9_0/os/introduction" selected="selected" >
    Version: 0.9.0
  </option>
</select></li>
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
  
  
    <li ><a href="../../../introduction/">Mynewt Documentation</a>
  
  
    <ul>
          
              
          
              
                
  
  
    <li ><a href="../../../get_started/get_started/">Basic Setup</a>
  
  
    </li>

              
          
              
                
  <li >
    <a href="../../../get_started/vocabulary/">Concepts</a>
  </li>

              
          
              
                
  
  
    <li ><a href="../../../tutorials/tutorials/">Tutorials</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../../os_user_guide/">OS User Guide</a>
  
  
    <ul>
          
              
          
              
                
  
  
    <li ><a href="../../../core_os/mynewt_os/">OS Core</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../../core_os/porting/port_os/">Porting to your Platform</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../console/console/">Console</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../shell/shell/">Shell</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../bootloader/bootloader/">Bootloader</a>
  
  
    </li>

              
          
              
                
  
  
    <li><a href="
  
  
  ../../fs/fs/fs/

">File System</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../hal/">Hardware Abstraction Layer</a>
  
  
    <ul>
          
              
          
              
                
  <li >
    <a href="../hal_architecture/">Architecture</a>
  </li>

              
          
              
                
  
  
    <li><a href="
  ../hal_api/
">API</a>
  
  
    </li>

              
          
              
                
  <li >
    <a href="../hal_in_libraries/">Using HAL</a>
  </li>

              
          
              
                
  <li class="active">
    <a href="./">Creating HAL</a>
  </li>

              
          
    </ul>
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../testutil/testutil/">Test Utilities</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../imgmgr/imgmgr/">Image Manager</a>
  
  
    </li>

              
          
              
                
  <li >
    <a href="../../baselibc/">Baselibc library</a>
  </li>

              
          
              
                
  
  
    <li ><a href="../../elua/elua/">Embedded Lua</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../json/json/">JSON</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../stats/stats/">Stats</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../logs/logs/">Logs</a>
  
  
    </li>

              
          
    </ul>
  
    </li>

              
          
              
                
  
  
    <li><a href="
  ../../../../network/ble/ble_intro/
">BLE User Guide</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../../../newt/newt_intro/">Newt Tool Guide</a>
  
  
    </li>

              
          
              
                
  
  
    <li ><a href="../../../../newtmgr/overview/">Newt Manager Guide</a>
  
  
    </li>

              
          
              
                
  <li >
    <a href="../../../../known_issues/">Known Issues</a>
  </li>

              
          
    </ul>
  
    </li>

        
      
        
          
  
  
    <li><a href="
  ../../../../faq/how_to_edit_docs/
">Appendix</a>
  
  
    </li>

        
      
    </ul>
</div></div>

                    <div class="col-md-9" role="main">
                        <div class="doc-header">
                            <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="/documentation/">Docs</a></li>
    
    
        
          <li>&raquo; <a href="os/modules/hal/hal/">Hardware Abstraction Layer</a></li>
        
      
        
          <li>&raquo; <a href="os/os_user_guide/">OS User Guide</a></li>
        
      
        
          <li>&raquo; <a href="os/introduction/">Mynewt Documentation</a></li>
        
      
      
        <li>&raquo; Creating HAL</li>
      
    
    
  </ul>
</div>
                        </div>
                        
                          
                        
                          
                            <div class="alert alert-warning">
                                <p>
                                    Version 0.9.0 is not the most recent version of the Apache Mynewt
                                    documentation. Click <a href="/latest">here</a> to read the latest
                                    version.
                                </p>
                            </div>
                          
                        
                          
                        
                        
                            <h1 id="creating-new-hal-interfaces">Creating New HAL Interfaces</h1>
<h2 id="hal-api">HAL API</h2>
<p>A HAL always includes header file with function declarations 
for the HAL functionality in <code>/hw/hal/include/hal</code>.
The first argument of all functions in the interface include the virtual 
device_id of the device you are controlling.  </p>
<p>For example, in <a href="https://github.com/apache/incubator-mynewt-larva/blob/master/hw/hal/include/hal/hal_gpio.h"><code>hal_gpio.h</code></a> 
the device enumeration is the first argument to all methods and called <code>pin</code>.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span></span>    void hal_gpio_set(int pin);
</pre></div>

<p>The device_id (in this case called <code>pin</code>) is not a physical device 
(actual hardware pin), but a virtual pin which is defined by the 
implementation of the HAL (and documented in the implementation of the HAL)</p>
<p>Below this, there are two different paradigms for HAL interface.  They are 
discussed below.</p>
<h2 id="direct-hal-interface">Direct HAL Interface</h2>
<p>In one HAL paradigm called <strong>direct HAL</strong>, the header file is the only component 
of the HAL interface.   Implementers of this HAL would create a source file
that implements these methods.  </p>
<p>This has the advantage of being simple, small, and low execution overhead.</p>
<p>It has the disadvantage that its not possible to have two different implementations
of the same <strong>direct HAL</strong> within the same image. Said another way, if I create
a <strong>direct HAL</strong> <code>hal_foo.h</code>, there can be many implementations of 
<code>xxx/hal_foo.c</code> but only one can be included in a project.  </p>
<p>For example, support there is an ADC attached directly to the MCU and an ADC
that is attached via SPI.  There would be no way in this simple paradigm
to use both these devices from the HAL API at the same time.</p>
<p>Current Direct HAL interfaces include:</p>
<table>
<thead>
<tr>
<th><strong>Hal Name</strong></th>
<th>** Interface File **</th>
</tr>
</thead>
<tbody>
<tr>
<td>[hal_gpio]</td>
<td><a href="https://github.com/apache/incubator-mynewt-larva/blob/master/hw/hal/include/hal/hal_gpio.h">hal_gpio.h</a></td>
</tr>
<tr>
<td>[hal_uart]</td>
<td><a href="https://github.com/apache/incubator-mynewt-larva/blob/master/hw/hal/include/hal/hal_uart.h">hal_uart.h</a></td>
</tr>
<tr>
<td>[hal_cputime]</td>
<td><a href="https://github.com/apache/incubator-mynewt-larva/blob/master/hw/hal/include/hal/hal_cputime.h">hal_cputime.h</a></td>
</tr>
</tbody>
</table>
<p>This brings up the second paradigm.</p>
<h2 id="indirect-hal-interface">Indirect HAL Interface</h2>
<p>The second paradigm, <strong>indirect HAL</strong>  preserves the simple function 
API with enumerated device_id but adds a small layer of code in the 
HAL to allow different implementations to connect at runtime.</p>
<p>The abstract interface contains three components:</p>
<ul>
<li>A header file <code>hal_foo.h</code> that includes the API above with a <code>device_id</code></li>
<li>An implementation <code>hal/hal_foo.c</code> which maps the <code>device_id</code> to 
a driver interface structure.  </li>
<li>A driver interface structure that is defined for the underlying implementation</li>
</ul>
<p>Using this simple model, the user can be exposed to a simple function 
interface (without structures or function pointers) and the system can provide
a different software implementation for each device id.</p>
<p>Although the GPIO interface for Mynewt uses the <strong>direct HAL</strong>, we can describe
what it might look like for an indirect HAL.  </p>
<p>The API <code>hal_gpio.h</code> is identical with a direct or indirect HAL.</p>
<p>In the indirect HAL there is an additional header file <code>hal_gpio_int.h</code>
 which describes the driver interface for underlying implementations.  It 
looks similar to the HAL API except is driven by function pointers.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span></span>struct hal_gpio_funcs {
    void (*hgpio_set)(void);
    . . .
};

struct hal_gpio_int {
    struct hal_gpio_funcs funcs;
}

const struct hal_gpio_int *bsp_gpio_dev(uint8_t pin);
</pre></div>

<p>The BSP specific function is what will map the specific pin (device_id) 
to its implementation.</p>
<p>This is different than the <strong>direct HAL</strong> which maps this virtual/physical 
device pairing in the MCU implementation.  For the <strong>indirect HAL</strong> the 
mapping has to be done in the BSP since that is the place where multiple 
disparate devices can be enumerated into a single <code>device_id</code> space.</p>
<p>An interface file <code>hal/hal_gpio.c</code> would perform the mapping as 
follows:</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span></span>    void hal_gpio_set(int pin) {
        const struct hal_gpio_int *pgpio;
        pgpio = bsp_get_gpio_device(pin);
        if(pgpio) {
            pgpio-&gt;funcs.set();
        }
    }
</pre></div>

<p>The implementer of GPIO functionality (say in <code>mcu/xxx/hal_gpio.c</code>) would 
implement the structure and provide the function pointers.</p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span></span>void xxx_hal_gpio_set(void) {
    /* implementation for this particular gpio device */
    . . .
}

struct hal_gpio_int xxx_hal_gpio = {
    .funcs.hgpio_set = xxx_hal_gpio_set;
}
</pre></div>

<p>This leaves the BSP implementation to complete the function </p>
<div class="codehilite" style="background: #ffffff"><pre style="line-height: 125%"><span></span>const struct hal_gpio_int *bsp_gpio_dev(uint8_t pin) {
    switch(pin) {
        case 0:
            return &amp;xxx_hal_gpio;
        case 1:
            return &amp;yyy_hal_gpio;
    }
    return NULL;
}
</pre></div>

<p><strong>NOTE</strong>: In this example there could be 10s of GPIO. It may be memory inefficient
to have that many <code>hal_gpio_int</code> structures around to basically call the 
same functions.  In Mynewt today, the hal_gpio is a <strong>direct HAL</strong> and does 
not have this overhead. More HAL paradigms may be added in the future to address 
the flexibility of the <strong>indirect HAL</strong> with the memory efficiency of the <strong>direct HAL</strong></p>
<p>Current Indirect HAL interfaces include:</p>
<table>
<thead>
<tr>
<th><strong>Hal Name</strong></th>
<th>** Interface File **</th>
</tr>
</thead>
<tbody>
<tr>
<td>hal_adc_int</td>
<td><a href="https://github.com/apache/incubator-mynewt-larva/blob/master/hw/hal/include/hal/hal_adc_int.h">hal_adc_int.h</a></td>
</tr>
<tr>
<td>hal_dac</td>
<td><a href="https://github.com/apache/incubator-mynewt-larva/blob/master/hw/hal/include/hal/hal_dac_int.h">hal_dac_int.h</a></td>
</tr>
<tr>
<td>hal_flash_int</td>
<td><a href="https://github.com/apache/incubator-mynewt-larva/blob/master/hw/hal/include/hal/hal_flash_int.h">hal_flash_int.h</a></td>
</tr>
<tr>
<td>hal_pwm_int</td>
<td><a href="https://github.com/apache/incubator-mynewt-larva/blob/master/hw/hal/include/hal/hal_pwm_int.h">hal_pwm_int.h</a></td>
</tr>
<tr>
<td>hal_i2c_int</td>
<td><a href="https://github.com/apache/incubator-mynewt-larva/blob/master/hw/hal/include/hal/hal_i2c_int.h">hal_i2c_int.h</a></td>
</tr>
<tr>
<td>hal_spi_int</td>
<td><a href="https://github.com/apache/incubator-mynewt-larva/blob/master/hw/hal/include/hal/hal_spi_int.h">hal_spi_int.h</a></td>
</tr>
</tbody>
</table>
                        
                        <div class="row">
                            



<ul class="nav nav-pills" style="margin-bottom: 10px">
    <li>
    
    </li>
    <li class="pull-right">
    
    </li>
</ul>
                        </div>
                        <footer class="row">
    <div class="col-xs-12">
        
            <p class="copyright">Apache Mynewt (incubating) is available under Apache License, version 2.0.</p>
        
    </div>
    <div class="col-xs-12">
        <div class="logos">
            <a href="https://www.apache.org/">
                <img src="/img/asf_logo_wide_small.png" alt="Apache" title="Apache">
            </a>
            <p>
                Copyright © 2015-2024 The Apache Software Foundation.<br>
                <small class="footnote">
                    Apache Mynewt, Mynewt, Apache, the Apache feather logo, and the Apache Mynewt
                    project logo are either registered trademarks or trademarks of the Apache
                    Software Foundation in the United States and other countries.
                </small>
            </p>
            <a href="">
                <img src="https://www.countit.com/images/add_to_slack.png" alt="Slack Icon" title="Join our Slack Community" />
            </a>
        </div>
    </div>
    <a href="https://www.apache.org/licenses/">
        <button class="button-footer-asf">
            License
        </button>
    </a>
    <a href="https://www.apache.org/foundation/sponsorship.html">
        <button class="button-footer-asf">
            Sponsorship
        </button>
    </a>
    <a href="https://www.apache.org/foundation/thanks.html">
        <button class="button-footer-asf">
            Thanks
        </button>
    </a>
    <a href="https://www.apache.org/security/">
        <button class="button-footer-asf">
            Security
        </button>
    </a>
    <a href="https://apache.org/events/current-event">
        <button class="button-footer-asf">
            ASF Events
        </button>
    </a>
</footer>
                    </div>
                </div>
            
            
        </div>

        <script src="../../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../../js/highlight.pack.js"></script>
        <script src="../../../../js/base.js"></script>
        <script src="../../../../js/custom.js"></script>
            <script src="search/main.js"></script>

    </body>
</html>